<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<title>
Matthias Vallentin - Analyzing Facebook Webchat Sessions with Bro
</title>
<link href='/css/main.css' rel='stylesheet'>
<link href='/css/prism.css' rel='stylesheet'>
<script src='/js/all.js'></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src='https://www.googletagmanager.com/gtag/js?id=UA-1823891-1'></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-1823891-1');
</script>

</head>
<body>
<main>
<div class='grid-x grid-padding-x align-center'>
<div class='cell medium-10 large-8'>
<div class='content'>
<h1>
Analyzing Facebook Webchat Sessions with Bro
</h1>
<div class='grid-x grid-padding-x align-justify margin-bottom-1'>
<div class='cell shrink'>
<span class='label radius'>
<i class='fa fa-calendar-o'></i>
2011-06-12
</span>
<span class='label radius warning'>
<i class='fa fa-calendar-plus-o'></i>
2012-11-24
</span>
</div>
<div class='cell shrink'>
<span class='label radius secondary'>
bro
</span>
<span class='label radius secondary'>
browser
</span>
<span class='label radius secondary'>
reverse engineering
</span>
<span class='label radius secondary'>
traffic analysis
</span>
</div>
</div>
<p><strong>Update</strong> (<em>November 24, 2012</em>): After Facebook <a href="http://techcrunch.com/2012/11/18/facebook-https/">switched to HTTPS
only</a>, this script no longer
works with life traffic.</p>

<p>The Facebook webchat allows you to chat with your friends while having a
Facebook window open in the browser. In this post, I describe how the webchat
protocol works and show how to write a <a href="http://www.bro-ids.org">Bro</a> script
that analyzes chat sessions.</p>

<h2 id="the-facebook-webchat-protocol">The Facebook Webchat Protocol</h2>

<p><img src="fb-icon.png" alt="Facebook" class="float-right margin-left-1" />
Behind the scenes, the webchat utilizes a long-lived AJAX connection to
send messages between the user and the Facebook server. A user that logs in
automatically opens such a connection, destined to
<code>^([0-9]+\.)+channel\.facebook.com$</code>, to receive asynchronous status updates
(e.g., notifications that your friends are currently typing). Whenever Facebook
wants to notify you, it encodes a message into a JSON object and ships it back
to you where some JavaScript munges on it. This AJAX channels contains both
control and data which creates an event-based communication channel to deliver
a low-latency user-experience on the client side.</p>

<p>As a traffic analyst, you might wonder how one can get insight into the
webchat protocol details and how to work with it at a higher level. After all,
who wants to write boilerplate code whose only purpose is to fight the
<em>representation of the data</em> rather than analyzing the data itself? Let us
extract messages from a Facebook webchat conversation and put them into
Bro data structures where they are easy to manipulate, print, and react upon.
This involves parsing the JSON objects, which look like this:</p>

<pre><code class="language-javascript">for (;;);{"t":"msg","c":"p_100002331422524","s":4,\&#x000A;  "ms":[{"window_id":1985081376,"type":"unfocus_chat"}]}&#x000A;</code></pre>

<p>The above example is an <code>unfocus_chat</code> event sent over the AJAX channel,
indicating that the user placed the focus somewhere else on the page, away from
the chat window. Here is another HTTP body:</p>

<pre><code class="language-javascript">for (;;);{"t":"msg","c":"p_100002331422524","s":6,"ms":[{"msg":{&#x000A;  "text":"So I need the URL, dude.  What is it?","time":1303218454567,\&#x000A;  "clientTime":1303218453582,"msgID":"2755876075"},"from":100002331422524,\&#x000A;  "to":100002297942500,"from_name":"Mondo Cheeze","from_first_name":"Mondo",\&#x000A;  "from_gender":2,"to_name":"Udder Kaos","to_first_name":"Udder",\&#x000A;  "to_gender":2,"type":"msg"&#x000A;}]}&#x000A;</code></pre>

<p>This one is an actual chat message. The nice thing is that such messages are
self-contained and include quite some meta information: contents, timestamps,
names, unique IDs, and even genders.</p>

<h2 id="the-bro-script">The Bro Script</h2>

<p>Alas, the HTTP body is a big fat opaque string with no structure and parsing
nested data in strings with just regular expression is clunky at best. (For
those who have spare cycles: an extremely useful project would be to create a
Bro analyzer that exposes first-class types of the DOM tree of a document and
script-level primitives for basic JavaScript analysis.) A crude way to do this
is splitting the string on <code>,"</code>, then finding the right key-value pairs, and
populating the following Bro data structures with the parsed data:</p>

<pre><code class="language-bro">type chat_message: record&#x000A;{&#x000A;    timestamp: string;  # Message timestamp.&#x000A;    from: string;       # Name of the sender&#x000A;    to: string;         # Name of the recipient.&#x000A;    text: string;       # The actual message.&#x000A;};&#x000A;&#x000A;type chat_session: record&#x000A;{&#x000A;    start: time;        # Unix timestamp of first message.&#x000A;    end: time;          # Unix timestamp of last message.&#x000A;    n: count;           # Total number of messages in session.&#x000A;};&#x000A;</code></pre>

<p>At this point it is easy to generate NOTICES with chat messages, look for
suspicious messages, and more generally, leverage Bro’s full scripting language
more effectively. I wrote a basic script that uses these data types to dump a
chat session between two buddies. You can download it as a <a href="https://gist.github.com/4141216">github
gist</a>. Here is the output of <code>facebook.bro</code> of a sample Facebook
webchat session:</p>

<pre><code class="language-none">1303218454567 (Mondo Cheeze -&gt; Udder Kaos) So I need the URL, dude.  What is it?&#x000A;1303218465938 (Udder Kaos -&gt; Mondo Cheeze) the URL?&#x000A;1303218474259 (Mondo Cheeze -&gt; Udder Kaos) Yeah for the secret image&#x000A;1303218481721 (Udder Kaos -&gt; Mondo Cheeze) ok lemme see&#x000A;1303218495626 (Mondo Cheeze -&gt; Udder Kaos) Someone could be sniffing this conversation, be sure to send it safely&#x000A;1303218503972 (Udder Kaos -&gt; Mondo Cheeze) ?&#x000A;1303218570782 (Mondo Cheeze -&gt; Udder Kaos) Cmon we talked about this.  Encrypt it with WonderCipher-92 \&#x000A;                                           and send me the Base64 encoding of the hex.  Usual key.&#x000A;1303218587568 (Udder Kaos -&gt; Mondo Cheeze) 'k.  So here it is:&#x000A;1303218595067 (Udder Kaos -&gt; Mondo Cheeze) NmQwMDJjZDdhZTdlYmYxNTc5MGVjZDc1YTYxNDk1OGE0ZTRhYjAzOTVi&#x000A;1303218618252 (Mondo Cheeze -&gt; Udder Kaos) What's the IV&#x000A;1303218624712 (Udder Kaos -&gt; Mondo Cheeze) huh?&#x000A;1303218637197 (Mondo Cheeze -&gt; Udder Kaos) Initialization vector, you maroon.  WC-92 is a stream cipher, you know&#x000A;1303218667601 (Udder Kaos -&gt; Mondo Cheeze) oh yeah.  I used my birthday, all as one number.&#x000A;1303218685436 (Udder Kaos -&gt; Mondo Cheeze) you *do* remember it, right?&#x000A;1303218700515 (Mondo Cheeze -&gt; Udder Kaos) yeah your an April Fool, not hard to remember&#x000A;1303218710402 (Udder Kaos -&gt; Mondo Cheeze) heh&#x000A;1303218718486 (Mondo Cheeze -&gt; Udder Kaos) K gimme a sec to decrypt then.&#x000A;1303218733463 (Mondo Cheeze -&gt; Udder Kaos) Hey idiot this isn't the secret, it's Google's home page.&#x000A;1303218745028 (Udder Kaos -&gt; Mondo Cheeze) whoops hang on, blew my cut&amp;paste&#x000A;1303218767633 (Udder Kaos -&gt; Mondo Cheeze) okay, here's the right one:&#x000A;1303218776922 (Udder Kaos -&gt; Mondo Cheeze) NmQwMDJjZDdhZTdlYmYwMDY3MGRjZDdlYjA1NDlhODQ0ZjA1YmEyNDRm&#x000A;1303218800303 (Mondo Cheeze -&gt; Udder Kaos) And?&#x000A;1303218807537 (Udder Kaos -&gt; Mondo Cheeze) and what&#x000A;1303218815022 (Mondo Cheeze -&gt; Udder Kaos) What's the IV&#x000A;1303218824330 (Udder Kaos -&gt; Mondo Cheeze) huh?&#x000A;1303218839537 (Mondo Cheeze -&gt; Udder Kaos) yo maroon same thing as we just discussed a moment ago, sheesh&#x000A;1303218855518 (Udder Kaos -&gt; Mondo Cheeze) oh that yeah like I said my birthday&#x000A;1303218869728 (Mondo Cheeze -&gt; Udder Kaos) You used the same IV as before????&#x000A;1303218889893 (Udder Kaos -&gt; Mondo Cheeze) right, otherwise how would I remember it?&#x000A;1303218900257 (Mondo Cheeze -&gt; Udder Kaos) YOU BOZO&#x000A;</code></pre>

<p>In summary, this is an example of how to translate low-level representation of
communication into higher abstractions that are easier to work with. After
creating first-class Bro types for the involved entities, one can now leverage
the real power of Bro’s scripting language.</p>


<div class='separator-center margin-bottom-2'></div>
<a class='button expanded hollow radius' href='#' id='show-comments' onclick='disqus();'>
Load Comments
</a>
<div id='disqus_thread'>
<script>
  var disqus_shortname = 'mavam';
  var disqus_config = function () {
    this.page.url = 'http://matthias.vallentin.net/blog/2011/06/analyzing-facebook-webchat-sessions-with-bro/';
    this.page.identifier = '';
  };
  var disqus_loaded = false;
  function disqus() {
    if (!disqus_loaded){
      disqus_loaded = true;
      var d = document, s = d.createElement('script');
      s.src = '//' + disqus_shortname +'.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      // Hide the button after loading comments.
      d.getElementById('show-comments').style.display = 'none';
      return false;
    }
  };
</script>
</div>


</div>
</div>
</div>
</main>
<footer>
<div class='grid-x grid-padding-x'>
<div class='cell shrink show-for-medium'>
<div class='copyright'>
<i class='fa fa-copyright'></i>
2007-2018 Matthias Vallentin
</div>

</div>
<div class='cell auto'>
<ul class='menu vertical medium-horizontal'>
<li>
<a href='/#home'>
Home
</a>
</li>
<li>
<a href='/#bio'>
Bio
</a>
</li>
<li>
<a href='/#research'>
Research
</a>
</li>
<li>
<a href='/#presentations'>
Presentations
</a>
</li>
<li>
<a href='/#coursework'>
Course Work
</a>
</li>
<li>
<a href='/#projects'>
Projects
</a>
</li>
<li>
<a href='/#teaching'>
Teaching
</a>
</li>
<li>
<a href='/#blog'>
Blog
</a>
</li>
</ul>
</div>
<div class='cell shrink show-for-medium'>
<ul class='menu social'>
<li>
<a href='mailto:matthias@berkeley.edu'>
<i class='fa fa-envelope'></i>
</a>
</li>
<li>
<a href='https://www.linkedin.com/in/matthias-vallentin/'>
<i class='fa fa-linkedin'></i>
</a>
</li>
<li>
<a href='https://github.com/mavam'>
<i class='fa fa-github'></i>
</a>
</li>
</ul>

</div>
</div>
<div class='hide-for-medium'>
<ul class='menu social'>
<li>
<a href='mailto:matthias@berkeley.edu'>
<i class='fa fa-envelope'></i>
</a>
</li>
<li>
<a href='https://www.linkedin.com/in/matthias-vallentin/'>
<i class='fa fa-linkedin'></i>
</a>
</li>
<li>
<a href='https://github.com/mavam'>
<i class='fa fa-github'></i>
</a>
</li>
</ul>

<div class='copyright'>
<i class='fa fa-copyright'></i>
2007-2018 Matthias Vallentin
</div>

</div>

</footer>
<!-- Enable Foundation -->
<script>
  $(document).foundation();
</script>

</body>
</html>
